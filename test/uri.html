<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="de">
	<head>
		<title>URI Test</title>
		
		<link rel="stylesheet" type="text/css" href="./css/test.css" />
		
		<script type="application/javascript" src="../lib/URI.js"></script>
		
		<script type="text/javascript">
			window.addEventListener('DOMContentLoaded', function() {
				debugger;
				
				var body = document.querySelector('body');
				
				var input = document.createElement('input');
				input.setAttribute('type', "text");
				input.value = "http://user:password@files.localnet:80/URL/test/url.html?q=test&item=abc,xyz,stu#location";
				input.addEventListener('keyup', onKeyUp, false);
				body.appendChild(input);
				
				var output = document.createElement('div');
				output.className = "output";
				body.appendChild(output);
				
				function onKeyUp() {
					var strurl = input.value;
					
					for (var node = output.firstChild; node; node = output.firstChild) output.removeChild(node);
					
					node = document.createElement('p');
					output.appendChild(node);

					
					try {
						var scheme = URIComponent.URIString(strurl, URIComponent.prototype.TYPE_SCHEME);
						var user   = URIComponent.URIString(strurl, URIComponent.prototype.TYPE_USER);
						var name   = URINameComponent.URIString(strurl);
						var port   = URIComponent.URIString(strurl, URIComponent.prototype.TYPE_PORT);
						var path   = URIPathComponent.URIString(strurl);
						var query  = URIComponent.URIString(strurl, URIComponent.prototype.TYPE_QUERY);
						var frag   = URIComponent.URIString(strurl, URIComponent.prototype.TYPE_FRAGMENT);
						
						if (!scheme.empty) {
							var child = document.createElement('span');
							child.className = "scheme";
							child.textContent = scheme;
							node.appendChild(child);
							
							node.appendChild(document.createTextNode(":"));
						}
						
						if (!user.empty) {
							node.appendChild(document.createTextNode("//"));
							
							child = document.createElement('span');
							child.className = "user";
							child.textContent = user;
							node.appendChild(child);
							
							node.appendChild(document.createTextNode("@"));
						}
						
						if (!name.empty) {
							if (user.empty) node.appendChild(document.createTextNode("//"));
							
							child = document.createElement('span');
							child.className = "name";
							node.appendChild(child);
							
							var segment = name.segment;
							
							for (var i = segment.length - 1; i > -1; i--) {
								var segmentNode = document.createElement('span');
								segmentNode.className = "name-segment";
								segmentNode.textContent = segment[i];
								child.appendChild(segmentNode);
								
								child.appendChild(document.createTextNode("."));
							}
							
							child.removeChild(child.lastChild);
						}
						
						if (!port.empty) {
							node.appendChild(document.createTextNode(":"));
							
							child = document.createElement('span');
							child.className = "port";
							child.textContent = port;
							node.appendChild(child);
						}
						
						if (!path.empty) {
							path.resolve();
							
							child = document.createElement('span');
							child.className = "path";
							if (path.absolute) child.classList.add('abs');
							if (!path.lastSegment) child.classList.add('end');
							node.appendChild(child);
							
							segment = path.segment;
							
							for (var i = 0; i < segment.length; i++) {
								segmentNode = document.createElement('span');
								segmentNode.className = "path-segment";
								segmentNode.textContent = segment[i];
								child.appendChild(segmentNode);
								
								child.appendChild(document.createTextNode("/"));
							}
							
							child.removeChild(child.lastChild);
						}
						
						if (!query.empty) {
							var queryData = URIKeyValue.String(query.string);
							query.string = queryData.string;
							queryData.string = query.string;
							
							URIKeyValue.Key(
								queryData.key,
								queryData.value,
								URIKeyValue.DELIMITER_DEFAULT_KEY,
								URIKeyValue.DELIMITER_DEFAULT_VALUE,
								URIKeyValue.SEPERATOR_DEFAULT_VALUE,
								queryData
							);
							
							node.appendChild(document.createTextNode("?"));
							
							child = document.createElement('span');
							child.className = "query";
							node.appendChild(child);
							
							var key = queryData.key;
							var val = queryData.value;
							
							for (var i = 0; i < key.length; i++) {
								segmentNode = document.createElement('span');
								segmentNode.className = "query-segment";
								child.appendChild(segmentNode);
								child.appendChild(document.createTextNode(queryData.keyLimit));
								
								var tokenNode = document.createElement('span');
								tokenNode.className = "query-key";
								tokenNode.textContent = key[i];
								segmentNode.appendChild(tokenNode);
								
								if (!val[key[i]]) continue;
								
								segmentNode.appendChild(document.createTextNode(queryData.valueLimit));
								
								for (var j = 0; j < val[key[i]].length; j++) {
									tokenNode = document.createElement('span');
									tokenNode.className = "query-value";
									tokenNode.textContent = val[key[i]][j];
									segmentNode.appendChild(tokenNode);
									segmentNode.appendChild(document.createTextNode(queryData.listLimit));
								}
								
								segmentNode.removeChild(segmentNode.lastChild);
							}
							
							child.removeChild(child.lastChild);
						}
						
						if (!frag.empty) {
//							var fragData = URIKeyValue.String(frag.string, "_", "-", "+");
							var fragData = URIKeyValue.String(frag.string);
							frag.string = fragData.string;
							
							URIKeyValue.Key(
								fragData.key,
								fragData.value,
								null,
								null,
								null,
								fragData
							);
							
							node.appendChild(document.createTextNode("#"));
							
							child = document.createElement('span');
							child.className = "frag";
							node.appendChild(child);
							
							key = fragData.key;
							val = fragData.value;
							
							for (i = 0; i < key.length; i++) {
								segmentNode = document.createElement('span');
								segmentNode.className = "frag-segment";
								child.appendChild(segmentNode);
								child.appendChild(document.createTextNode(fragData.keyLimit));
								
								tokenNode = document.createElement('span');
								tokenNode.className = "frag-key";
								tokenNode.textContent = key[i];
								segmentNode.appendChild(tokenNode);
								
								if (!val[key[i]]) continue;
								
								segmentNode.appendChild(document.createTextNode(fragData.valueLimit));
								
								for (j = 0; j < val[key[i]].length; j++) {
									tokenNode = document.createElement('span');
									tokenNode.className = "frag-value";
									tokenNode.textContent = val[key[i]][j];
									segmentNode.appendChild(tokenNode);
									segmentNode.appendChild(document.createTextNode(fragData.listLimit));
								}
								
								segmentNode.removeChild(segmentNode.lastChild);
							}
							
							child.removeChild(child.lastChild);
						}
						
						if (node.childNodes.length) {
							node.appendChild(document.createTextNode(" parsed."));							
							return;
						}
						
						child = document.createElement('span');
						child.className = "none";
						child.textContent = "empty";
						node.appendChild(child);
						output.appendChild(node);
						
						return;
					} catch(err) {
						node = document.createElement('p');
						output.appendChild(node);
						
						child = document.createElement('span');
						child.className = 'string';
						child.textContent = strurl;
						node.appendChild(child);
						
						node.appendChild(document.createTextNode(" not parsed. reason: "));
						
						child = document.createElement('span');
						child.className = 'error';
						child.textContent = err;
						node.appendChild(child);
						
						node.appendChild(document.createTextNode("."));
					}
				}
				
				
				onKeyUp(null);
			}, false);
		</script>
	</head>
	
	<body></body>
</html>